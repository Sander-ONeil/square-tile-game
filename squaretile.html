<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Square Tile</title>
</head>
<body>

        <canvas id="box" width="600" height="600"></canvas>

    <script>
var canvas = document.getElementById('box');
var ctx = canvas.getContext('2d');



function draw_tile(x,y,color = "blue"){
    ctx.fillStyle = color;
    var width = 20;
    var height = 20;
    ctx.fillRect(x, y, width, height);
    const vertices = [
    { x: 0, y: 0 },
    { x: 1, y: 0 },
    { x: .7, y: .3 },
    { x: .3, y: .3 },
    ]
    ctx.beginPath();
    for (let i = 0; i < vertices.length; i++) {
        ctx.lineTo(vertices[i].x*width + x, vertices[i].y*height + y);
    }
    ctx.closePath(); 
    ctx.fillStyle = "light" + color;
    ctx.fill(); 
    ctx.beginPath();
    for (let i = 0; i < vertices.length; i++) {
        ctx.lineTo(vertices[i].x*width + x, height - vertices[i].y*height + y);
    }
    ctx.closePath(); 
    ctx.fillStyle = "dark" + color;
    ctx.fill(); 
}

function draw_board(board){
    width = 180
    height = 180
    spacing = 10
    ctx.fillStyle = 'grey';
    ctx.fillRect(spacing, spacing, width, height);
    var number = 9.0;
    var linewidth = 1;
    ctx.fillStyle = 'black';
    for (var i = 0.0; i < number+1; i +=1.0){
        if (i == 3 || i == 6) {linewidth = 2}
        else { linewidth = 1}
        ctx.fillRect(spacing + width*i/number, spacing, linewidth, height);
        ctx.fillRect(spacing,spacing + height*i/number,width, linewidth);
    }
    for (var j = 0; j < number; j +=1)
    for (var i = 0; i < number; i +=1){
        var num = Math.floor(i/3)+Math.floor(j/3)*3;
        var subnum = i % 3 + (j % 3) * 3;
        var hash = 1 << subnum;
        
        full = (board.nums[num] & hash) > 0

        if (full) {
            draw_tile(spacing + width*i/number,spacing + height*j/number)
        }
    }
}

function animate_win(board){
    width = 180
    height = 180
    spacing = 10

    var number = 9.0;
    for (var j = 0; j < number; j +=1)
    for (var i = 0; i < number; i +=1){
        var num = Math.floor(i/3)+Math.floor(j/3)*3;
        var subnum = i % 3 + (j % 3) * 3;
        var hash = 1 << subnum;
        
        full = (board.nums[num] & hash) > 0

        if (full) {
            draw_tile(spacing + width*i/number,spacing + height*j/number,"white")
        }
    }
}

function draw_shape(x,y,shape,color = 'red'){
    tiles = shape.tiles
    for (var i = 0; i < tiles.length; i +=1)
    {
        //console.log(x+tiles[i][x]*20,y+tiles[i][y]*20,color)
        draw_tile(x+tiles[i].x*20,y+tiles[i].y*20,color)
    }
}

function coords_from_event(event){
    return {x: Math.floor((event.clientX - 20) / 20), y: Math.floor((event.clientY - 20) / 20)}
}

function check_wins(board)
{
    notboard = new Board()

    for (var i = 0; i < 9; i +=1)
    {
        if (board.nums[i] == 511){
            notboard.nums[i] = 511
        }
    }

    for (var i = 0; i < board.nums.length; i +=1)
    {
    board.nums[i] = board.nums[i] ^ notboard.nums[i]
    }
    animate_win(notboard)
}

class Board {
    constructor(){
        this.nums = new Int16Array([0,0,0,0,0,0,0,0,0])
    }
}

class shape {
    constructor(){
        this.tiles = [
    { x: 0, y: 0 },{ x: 1, y: 0 },
    ]
    }
}
console.log(2&2)
TheBoard = new Board()
TheShape = new shape()
canvas.addEventListener('mousemove', function(event) {
    // while (element.matches(':hover')) {
    ctx.clearRect(0,0,600,600)
    draw_board(TheBoard)
    if (event.clientX<200 && event.clientY<200){
        var coords = coords_from_event(event)
        draw_shape(coords.x*20+10,coords.y*20+10,TheShape,"green")
    }
    else {draw_shape(event.clientX,event.clientY,TheShape,"green")
}    // }
});

canvas.addEventListener('mousedown', function(event) {
    tiles = TheShape.tiles
    var coords = coords_from_event(event)
    console.log(coords)
    var anyfull = false
    for (var i = 0; i < tiles.length; i +=1)
    {
        var X = coords.x + tiles[i].x;
        var Y = coords.y + tiles[i].y;
        var num = Math.floor(X/3)+Math.floor(Y/3)*3;
        var subnum = X % 3 + (Y % 3) * 3;
        var hash = 1 << subnum;
        full = (TheBoard.nums[num] & hash) > 0
        anyfull = full || anyfull
    }
    if (anyfull){
        console.log("tile full cancel")
    }
    else
    {
        for (var i = 0; i < tiles.length; i +=1)
        {
            var X = coords.x + tiles[i].x;
            var Y = coords.y + tiles[i].y;
            var num = Math.floor(X/3)+Math.floor(Y/3)*3;
            var subnum = X % 3 + (Y % 3) * 3;
            var hash = 1 << subnum;
            TheBoard.nums[num] += hash
        }
    }
    check_wins(TheBoard)
});



    </script>
</body>
</html>